### Apply patches

cp *.patch /opt/gitlab/embedded/service/gitlab-rails
cd /opt/gitlab/embedded/service/gitlab-rails
git am *.patch
chmod -R a+rX app config

### Rebuild compiled CSS files

# Need to let user `git` write to assets/ because gitlab-rake tries to write
# to it as `git`, while `assets/` is owned by root.
setfacl -R -m u:git:rwX /opt/gitlab/embedded/service/gitlab-rails/public/assets/
gitlab-rake assets:precompile RAILS_ENV=production
chmod -R a+rX /opt/gitlab/embedded/service/gitlab-rails/public/assets/

# Remove git's write access
setfacl -R -x u:git /opt/gitlab/embedded/service/gitlab-rails/public/assets/

gitlab-ctl restart

### Alternatively

cd /opt/gitlab/embedded/service/gitlab-rails
chmod -R a+rX app && gitlab-rake assets:precompile RAILS_ENV=production && chmod -R a+rX public/assets/ && gitlab-ctl restart
